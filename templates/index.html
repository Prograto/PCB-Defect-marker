<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PCB Defect Detection — Enhanced UI</title>
  <style>
    :root{
      --bg: #f5f7fb;           /* soft off-white */
      --panel: #ffffff;        /* card background */
      --muted: #6b7280;        /* mid gray */
      --text: #0f1724;         /* dark slate text */
      --accent: #2dd4bf;       /* calm teal */
      --accent-2: #ef4444;     /* alert / error red */
      --glass: rgba(15,23,36,0.03);
      --radius: 12px;
      --gap: 16px;
      --shadow: 0 10px 30px rgba(15,23,36,0.06);
      --soft-shadow: 0 6px 18px rgba(15,23,36,0.04);
      --code-bg: #f2f6fa;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    html,body {
      height:100%;
      margin:0;
      background: linear-gradient(180deg, #eef3f8 0%, var(--bg) 60%);
      color: var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .container {
      max-width:1100px;
      margin:32px auto;
      padding:20px;
    }

    header {
      display:flex;
      align-items:center;
      gap:16px;
      margin-bottom:18px;
    }
    .logo {
      width:56px;
      height:56px;
      border-radius:10px;
      background: linear-gradient(135deg, #60a5fa 0%, var(--accent) 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-weight:700;
      box-shadow: var(--soft-shadow);
    }
    h1 { font-size:20px; margin:0; letter-spacing: -0.2px; }
    p.lead { margin:0; color:var(--muted); font-size:13px }

    .grid {
      display:grid;
      grid-template-columns:1fr 380px;
      gap:var(--gap);
      align-items:start;
    }

    .card {
      background: var(--panel);
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(15,23,36,0.04);
    }

    /* Dropzone */
    .dropzone {
      border:2px dashed rgba(15,23,36,0.06);
      padding:18px;
      border-radius:10px;
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
      justify-content:center;
      background: linear-gradient(180deg, rgba(15,23,36,0.01), transparent);
      min-height:220px;
    }
    .dropzone.dragover { border-color: rgba(45,212,191,0.5); background: rgba(45,212,191,0.02); }

    .dz-btn {
      display:inline-flex;
      align-items:center;
      gap:10px;
      background: linear-gradient(90deg, #34d399 0%, #2dd4bf 100%);
      color: #072d29;
      padding:8px 12px;
      border-radius:10px;
      font-weight:600;
      border:none;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(45,212,191,0.12);
    }

    .muted { color: var(--muted); font-size:13px; }
    .meta { font-size:13px; color:var(--muted); }

    form .row { display:flex; gap:10px; align-items:center; }
    input[type=file] { display:none; }

    .preview {
      width:100%;
      height:260px;
      border-radius:8px;
      overflow:hidden;
      border:1px solid rgba(15,23,36,0.04);
      display:flex;
      align-items:center;
      justify-content:center;
      background: var(--code-bg);
    }
    .preview img { max-width:100%; max-height:100%; display:block; }

    /* Result / download */
    .result-title { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .badge {
      background: rgba(15,23,36,0.04);
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      color:var(--muted);
      font-size:13px;
    }
    .download-btn {
      background: linear-gradient(90deg, #60a5fa 10%, #2dd4bf 100%);
      padding:8px 12px;
      border-radius:10px;
      color: #042f2c;
      text-decoration:none;
      font-weight:700;
      box-shadow: 0 8px 20px rgba(45,212,191,0.08);
    }

    /* Sidebar smaller cards */
    .sidebar .small-card { background: linear-gradient(180deg, rgba(15,23,36,0.01), transparent); padding:12px; border-radius:8px; margin-bottom:12px; border:1px solid rgba(15,23,36,0.02); }
    .small-note { font-size:13px; color:var(--muted); }

    footer { color:var(--muted); margin-top:18px; font-size:13px; text-align:center; }

    @media (max-width:980px) {
      .grid { grid-template-columns: 1fr; }
      .preview { height:200px; }
      .download-btn { font-size:14px; padding:8px 10px; }
    }

    /* Flash */
    .flashes { margin-bottom:12px; }
    .flash {
      background: linear-gradient(180deg, rgba(45,212,191,0.06), rgba(45,212,191,0.02));
      padding:10px;
      border-radius:8px;
      color: #05332f;
      border-left:4px solid rgba(45,212,191,0.8);
      font-weight:600;
    }

    /* small utility */
    code { background: #eef6f8; padding:4px 6px; border-radius:6px; color: #0b3140; font-size:12px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">PCB</div>
      <div>
        <h1>PCB Defect Detection</h1>
        <p class="lead">Upload a PCB image (or paste an image URL) → detect defects using template subtraction + alignment. Results are downloadable.</p>
      </div>
    </header>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flashes">
        {% for m in messages %}
          <div class="flash">{{ m }}</div>
        {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="grid">
      <div>
        <div class="card">
          <form method="post" enctype="multipart/form-data" id="uploadForm">
            <div class="dropzone" id="dropzone">
              <div class="muted">Drag & drop an image here or</div>
              <div class="row">
                <label class="dz-btn" for="fileInput">Choose image</label>
                <input id="fileInput" type="file" name="image" accept="image/*" />
                <button type="submit" class="dz-btn" style="background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);">Analyze</button>
              </div>
              <div class="muted">Or paste an image URL below</div>
              <input type="text" name="image_url" id="imageUrl" placeholder="https://..." style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;margin-top:8px;">
              <div style="font-size:12px;color:var(--muted);margin-top:6px">Tip: Place a clean non-defective PCB image in <code>templates_db/</code> named <strong>template1.jpg</strong>.</div>
            </div>
          </form>

          <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div>
              <div class="meta">Preview</div>
              <div class="preview" id="previewBox"><div class="muted">No image selected</div></div>
            </div>
            <div>
              <div class="meta">Settings</div>
              <div class="small-card" style="margin-top:8px">
                <label class="switch"><input type="checkbox" id="overlayToggle" checked> <span style="color:var(--muted)">Show semi-transparent red overlay</span></label>
                <div style="height:8px"></div>
                <label class="switch"><input type="checkbox" id="useUrlToggle"> <span style="color:var(--muted)">Analyze image URL (if provided)</span></label>
              </div>
            </div>
          </div>
        </div>

        {% if result_image %}
        <div class="card" style="margin-top:14px">
          <div class="result-title">
            <div>
              <div class="meta">Result Image</div>
              <div style="font-weight:700">Defected regions highlighted</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <div class="badge">Defects: {{ defects }}</div>
              <a class="download-btn" href="{{ url_for('download', name=result_name) }}">Download</a>
            </div>
          </div>

          <div style="margin-top:12px">
            <img src="{{ result_image.replace('\\','/') }}" alt="result image" style="width:100%;border-radius:8px;border:1px solid rgba(255,255,255,0.03);">
            <div style="margin-top:8px;font-size:13px;color:var(--muted)">
              <a href="{{ result_image }}" target="_blank" rel="noopener noreferrer">Open image in new tab</a>
              &nbsp;•&nbsp;
              <a href="{{ url_for('download', name=result_name) }}">Direct download</a>
            </div>
          </div>

          <details style="margin-top:12px;color:var(--muted)">
            <summary style="cursor:pointer">Advanced: view binary diff</summary>
            <div style="margin-top:8px"><img src="{{ diff_image.replace('\\','/') }}" alt="diff" style="width:100%;border-radius:6px;border:1px solid rgba(255,255,255,0.03)"></div>
          </details>
        </div>
        {% endif %}

      </div>

      <aside class="sidebar">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div class="meta">Template status</div>
              <div style="font-weight:700">templates_db/template1.jpg</div>
            </div>
            <div class="badge">Required</div>
          </div>
          <div style="margin-top:12px;color:var(--muted);font-size:13px">If there's no template, add a clean non-defective PCB image to the <code>templates_db/</code> folder and name it <code>template1.jpg</code>. Small differences in viewpoint are handled by alignment.</div>
        </div>

        <div class="small-card card" style="margin-top:12px">
          <div style="font-weight:700">Quick tips</div>
          <ul style="color:var(--muted);font-size:13px">
            <li>Use same PCB model as template & test.</li>
            <li>Prefer clear top-down photos with consistent lighting.</li>
            <li>Tweak area filters in code if you see noise or missed defects.</li>
          </ul>
        </div>

        <div class="small-card card" style="margin-top:12px">
          <div style="font-weight:700">Dev helpers</div>
          <div class="muted" style="font-size:13px">Want auto template selection, PCB classifier, or YOLO detector? Reply which and I'll extend the server code.</div>
        </div>
      </aside>
    </div>

    <footer>Built for your Flask + OpenCV backend. Need a light theme or extra tuning controls? Ask me.</footer>
  </div>

  <script>
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const previewBox = document.getElementById('previewBox');
    const form = document.getElementById('uploadForm');
    const imageUrlInput = document.getElementById('imageUrl');

    // progress UI
    const progressWrap = document.createElement('div');
    progressWrap.style.marginTop = '12px';
    progressWrap.innerHTML = `<div style="background:rgba(255,255,255,0.03);height:10px;border-radius:8px;overflow:hidden">
        <div id="uploadProgress" style="height:100%;width:0%;transition:width 200ms ease"></div>
      </div><div id="progressText" style="font-size:12px;color:var(--muted);margin-top:6px"></div>`;
    dropzone.parentNode.insertBefore(progressWrap, dropzone.nextSibling);
    const uploadProgress = document.getElementById('uploadProgress');
    const progressText = document.getElementById('progressText');

    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
    dropzone.addEventListener('dragleave', e => { dropzone.classList.remove('dragover'); });
    dropzone.addEventListener('drop', e => {
      e.preventDefault(); dropzone.classList.remove('dragover');
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) { fileInput.files = e.dataTransfer.files; showPreview(f); }
    });

    fileInput.addEventListener('change', e => { const f = e.target.files[0]; if (f) showPreview(f); });

    function showPreview(file) {
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      img.onload = () => { URL.revokeObjectURL(img.src); }
      previewBox.innerHTML = '';
      previewBox.appendChild(img);
    }

    function clearOldResult() {
      const existing = document.querySelector('.card.result-dynamic');
      if (existing) existing.remove();
    }

    function displayResultJson(data) {
      clearOldResult();
      const container = document.createElement('div');
      container.className = 'card result-dynamic';
      container.style.marginTop = '14px';
      const badge = `<div class="badge">Defects: ${data.defects}</div>`;
      const downloadBtn = `<a class="download-btn" href="/download?name=${encodeURIComponent(data.result_name)}">Download</a>`;
      container.innerHTML = `
        <div class="result-title">
          <div>
            <div class="meta">Result Image</div>
            <div style="font-weight:700">Defected regions highlighted</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">${badge} ${downloadBtn}</div>
        </div>
        <div style="margin-top:12px">
          <img src="${data.result_image}" alt="result image" style="width:100%;border-radius:8px;border:1px solid rgba(255,255,255,0.03);">
          <div style="margin-top:8px;font-size:13px;color:var(--muted)"><a href="${data.result_image}" target="_blank" rel="noopener noreferrer">Open image in new tab</a> &nbsp;•&nbsp; <a href="/download?name=${encodeURIComponent(data.result_name)}">Direct download</a></div>
        </div>
        <details style="margin-top:12px;color:var(--muted)"><summary style="cursor:pointer">Advanced: view binary diff</summary><div style="margin-top:8px"><img src="${data.diff_image}" alt="diff" style="width:100%;border-radius:6px;border:1px solid rgba(255,255,255,0.03)"></div></details>
      `;
      const leftColumn = document.querySelector('.grid > div');
      if (leftColumn) leftColumn.appendChild(container);
    }

    function showTempMessage(msg, isError = false) {
      const flash = document.createElement('div');
      flash.className = 'flash';
      flash.style.borderLeft = isError ? '4px solid rgba(239,68,68,0.8)' : undefined;
      flash.textContent = msg;
      const container = document.querySelector('.container');
      container.insertBefore(flash, container.firstChild.nextSibling);
      setTimeout(() => flash.remove(), 4500);
    }

    form.addEventListener('submit', e => {
      e.preventDefault();
      clearOldResult();
      uploadProgress.style.width = '0%';
      progressText.textContent = '';

      const formData = new FormData();
      const file = fileInput.files && fileInput.files[0];
      const urlVal = imageUrlInput.value && imageUrlInput.value.trim();

      if (file) {
        formData.append('image', file);
      } else if (urlVal) {
        formData.append('image_url', urlVal);
      } else {
        showTempMessage('Please choose an image file or enter an image URL.', true);
        return;
      }

      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/analyze', true);

      xhr.upload.onprogress = function (e) {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          uploadProgress.style.width = percent + '%';
          progressText.textContent = `Uploading... ${percent}%`;
        }
      };

      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
          uploadProgress.style.width = '100%';
          progressText.textContent = 'Processing...';
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              const data = JSON.parse(xhr.responseText);
              if (data.ok) {
                displayResultJson(data);
                showTempMessage('Analysis complete.');
              } else {
                showTempMessage(data.message || 'Analysis failed.', true);
              }
            } catch (err) {
              showTempMessage('Invalid server response.', true);
              console.error(err);
            }
          } else {
            try {
              const err = JSON.parse(xhr.responseText);
              showTempMessage(err.message || 'Upload failed.', true);
            } catch (err2) {
              showTempMessage('Upload failed.', true);
            }
          }
          setTimeout(() => { uploadProgress.style.width = '0%'; progressText.textContent = '' }, 1800);
        }
      };

      xhr.onerror = function () {
        showTempMessage('Network error during upload.', true);
      };

      xhr.send(formData);
    });
  </script>
</body>
</html>
